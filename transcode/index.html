<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ImageMagick 图片转码工具</title>
    <script src="./imagemagick/index.umd.cjs"></script>
    <script src="./ffmpeg/ffmpeg.js"></script>
    <script src="./ffmpeg/index.js"></script>
    <script src="./work/const.js"></script>
    <script src="./work/errors.js"></script>
    <script src="./work/worker.js"></script>

    <!-- 参考这个 issue 试试 -->
    <!-- https://github.com/ffmpegwasm/ffmpeg.wasm/issues/617  -->

    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      button {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        font-weight: bold;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .image-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }
      .image-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #f9f9f9;
      }
      .image-item img {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      .image-info {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
      }
      .download-btn {
        background: #28a745;
        font-size: 14px;
        padding: 8px 16px;
      }
      .download-btn:hover {
        background: #218838;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="controls">
        <button id="selectFolder">选择文件夹</button>
        <button id="processImages" disabled>处理图片</button>
        <button id="processVideos" disabled>处理视频</button>
      </div>

      <div id="status" class="status" style="display: none"></div>

      <div id="imageGallery" class="image-gallery"></div>
    </div>

    <script>
      // 使用 UMD 版本，避免 ES6 模块的跨域问题
      const { initializeImageMagick, ImageMagick, MagickFormat } =
        window["magick-wasm"] || {};

      const { FFmpeg } = FFmpegWASM || {};
      const { fetchFile, toBlobURL } = FFmpegUtil || {};

      console.log(Object.keys(window));

      let selectedFolder = null;
      let imageFiles = [];
      let videoFiles = [];
      let wasmFile = {};
      let ffmpegFile = {
        wasm: null,

        core: null,
      };
      let isImageMagickInitialized = false;
      let isFFmpegInitialized = false;
      let ffmpeg = null;

      // 初始化 ImageMagick（使用用户选择的 WASM 文件）
      async function initializeImageMagickWithWasm(wasmFile) {
        try {
          // 检查 UMD 库是否加载成功
          if (!initializeImageMagick || !ImageMagick) {
            throw new Error(
              "ImageMagick 库未正确加载，请检查 dist/index.umd.cjs 文件"
            );
          }

          showStatus("正在初始化 ImageMagick...", "info");

          // 使用用户选择的 WASM 文件
          const wasmArrayBuffer = await wasmFile.arrayBuffer();
          await initializeImageMagick(wasmArrayBuffer);

          isImageMagickInitialized = true;
          showStatus("ImageMagick 初始化成功！", "success");
        } catch (error) {
          console.error("ImageMagick 初始化失败:", error);
          showStatus(`ImageMagick 初始化失败: ${error.message}`, "error");
        }
      }

      // 初始化 FFmpeg（使用用户选择的文件）
      async function initializeFFmpegWithFiles(
        coreJsFile,
        wasmFile,
        workerFile
      ) {
        try {
          if (!FFmpeg) {
            throw new Error("FFmpeg 库未正确加载");
          }

          showStatus("正在初始化 FFmpeg...", "info");

          ffmpeg = new FFmpeg();

          ffmpeg.on("log", ({ message }) => {
            console.log(message);
          });

          ffmpeg.on("progress", ({ progress }) => {
            showStatus(
              `FFmpeg 处理进度: ${Math.round(progress * 100)}%`,
              "info"
            );
          });

          // 创建 Blob URLs

          console.log("workerFile:", workerFile);
          console.log("coreJsFile 是 Blob 吗?", coreJsFile instanceof Blob);
          console.log("coreJsFile 是 File 吗?", coreJsFile instanceof File);

          // const arrayBuffer = await coreJsFile.buffer;
          // console.log("ArrayBuffer byteLength:", arrayBuffer.byteLength);
          // if (arrayBuffer.byteLength === 0) {
          //   console.error("ArrayBuffer 是空的！");
          // }

          // const coreURL = URL.createObjectURL(
          //   new Blob([arrayBuffer], {
          //     type: "text/javascript",
          //   })
          // );
          // const wasmURL = new Blob([await wasmFile.buffer], {
          //   type: "application/wasm",
          // });

          await ffmpeg.load({
            coreURL: coreJsFile,
            wasmURL: wasmFile,

            // classWorkerURL: new Blob([await workerFile.arrayBuffer()]),
          });

          isFFmpegInitialized = true;
          showStatus("FFmpeg 初始化成功！", "success");
        } catch (error) {
          console.error("FFmpeg 初始化失败:", error);
          showStatus(`FFmpeg 初始化失败: ${error.message}`, "error");
        }
      }

      // 显示状态信息
      function showStatus(message, type = "info") {
        const statusEl = document.getElementById("status");
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.style.display = "block";
      }

      // 隐藏状态信息
      function hideStatus() {
        document.getElementById("status").style.display = "none";
      }

      // 选择文件夹
      async function selectFolder() {
        try {
          if (!("showDirectoryPicker" in window)) {
            showStatus("您的浏览器不支持文件系统访问 API", "error");
            return;
          }

          selectedFolder = await window.showDirectoryPicker();
          imageFiles = [];
          videoFiles = [];
          wasmFile = null;
          ffmpegFile = {
            wasm: null,
            worker: null,
            core: null,
          };

          showStatus("正在扫描文件夹中的文件...", "info");

          // 扫描文件夹中的图片、视频和相关文件
          await scanForFiles(selectedFolder);

          let hasContent = false;
          let statusMessages = [];

          if (imageFiles.length > 0) {
            statusMessages.push(`${imageFiles.length} 个图片文件`);
            hasContent = true;
          }

          if (videoFiles.length > 0) {
            statusMessages.push(`${videoFiles.length} 个视频文件`);
            hasContent = true;
          }

          if (!hasContent) {
            showStatus("文件夹中没有找到图片或视频文件", "error");
            return;
          }

          showStatus(`找到 ${statusMessages.join("、")}`, "success");

          if (imageFiles.length > 0) {
            document.getElementById("processImages").disabled = false;
          }

          if (videoFiles.length > 0) {
            document.getElementById("processVideos").disabled = false;
          }
        } catch (error) {
          if (error.name !== "AbortError") {
            showStatus(`选择文件夹失败: ${error.message}`, "error");
          }
        }
      }

      // 扫描文件夹中的图片、视频和相关文件
      async function scanForFiles(dirHandle, path = "") {
        for await (const entry of dirHandle.values()) {
          if (entry.kind === "file") {
            const file = await entry.getFile();
            console.log(file); // 打印文件信息

            // 支持的图片格式扩展名（不区分大小写）
            const imageExtensions = [
              ".jpg",
              ".jpeg",
              ".png",
              ".gif",
              ".bmp",
              ".webp",
              ".svg",
              ".tiff",
              ".tif",
              ".heic",
              ".heif",
              ".psd",
              ".raw",
              ".cr2",
              ".nef",
              ".arw",
              ".dng",
              ".ico",
            ];

            // 支持的视频格式扩展名
            const videoExtensions = [
              ".mp4",
              ".avi",
              ".mov",
              ".mkv",
              ".wmv",
              ".flv",
              ".webm",
              ".m4v",
              ".3gp",
              ".ts",
              ".mts",
              ".m2ts",
            ];

            const fileName = file.name.toLowerCase();

            const isImage = imageExtensions.some((ext) =>
              fileName.endsWith(ext)
            );

            const isVideo = videoExtensions.some((ext) =>
              fileName.endsWith(ext)
            );

            if (isImage) {
              imageFiles.push({
                handle: entry,
                file: file,
                path: path ? `${path}/${file.name}` : file.name,
              });
            } else if (isVideo) {
              videoFiles.push({
                handle: entry,
                file: file,
                path: path ? `${path}/${file.name}` : file.name,
              });
            } else if (file.name === "magick.wasm") {
              wasmFile = {
                handle: entry,
                file: file,
                path: path ? `${path}/${file.name}` : file.name,
                type: "magick",
              };
            } else if (file.name === "ffmpeg-core.js") {
              ffmpegFile.core = {
                handle: entry,
                file: file,
                path: path ? `${path}/${file.name}` : file.name,
                type: "core-js",
              };
            } else if (file.name === "ffmpeg-core.wasm") {
              ffmpegFile.wasm = {
                handle: entry,
                file: file,
                path: path ? `${path}/${file.name}` : file.name,
                type: "core-wasm",
              };
            } else if (file.name === "worker.js") {
              ffmpegFile.worker = {
                handle: entry,
                file: file,
                path: path ? `${path}/${file.name}` : file.name,
                type: "worker",
              };
            }
          } else if (entry.kind === "directory") {
            // 递归扫描子文件夹
            const subPath = path ? `${path}/${entry.name}` : entry.name;
            await scanForFiles(entry, subPath);
          }
        }
      }

      // 处理图片
      async function processImages() {
        // 如果尚未初始化，先使用找到的WASM文件初始化
        if (!isImageMagickInitialized) {
          const magickWasm = wasmFile;
          if (!magickWasm) {
            showStatus(
              "没有找到 magick.wasm 文件，无法初始化 ImageMagick",
              "error"
            );
            return;
          }

          // 使用找到的 magick.wasm 文件进行初始化
          await initializeImageMagickWithWasm(magickWasm.file);

          if (!isImageMagickInitialized) {
            showStatus("ImageMagick 初始化失败", "error");
            return;
          }
        }

        if (imageFiles.length === 0) {
          showStatus("没有选择图片文件", "error");
          return;
        }

        const gallery = document.getElementById("imageGallery");
        gallery.innerHTML = "";

        showStatus(`正在处理 ${imageFiles.length} 个图片...`, "info");

        let processedCount = 0;

        console.log(imageFiles); // 打印 imageFiles 数组的内容

        for (const imageItem of imageFiles) {
          try {
            const arrayBuffer = await imageItem.file.arrayBuffer();
            const array = new Uint8Array(arrayBuffer);

            await new Promise((resolve, reject) => {
              try {
                ImageMagick.read(array, (image) => {
                  try {
                    writeImage(image, imageItem.file.name, imageItem.path);

                    processedCount++;
                    showStatus(
                      `已处理 ${processedCount}/${imageFiles.length} 个图片`,
                      "info"
                    );
                    resolve();
                  } catch (error) {
                    reject(error);
                  }
                });
              } catch (error) {
                // 如果处理失败，创建错误信息图片
                const settings = createReadSettings();
                settings.fontPointsize = 20;
              }
            });
          } catch (error) {
            console.error(`处理图片 ${imageItem.file.name} 失败:`, error);
          }
        }

        showStatus(`处理完成！共处理了 ${processedCount} 个图片`, "success");
      }

      // 处理视频
      async function processVideos() {
        // 如果尚未初始化，先使用找到的FFmpeg文件初始化
        if (!isFFmpegInitialized) {
          const coreJsFile = ffmpegFile.core.file;
          const coreWasmFile = ffmpegFile.wasm.file;
          const coreWorkerFile = ffmpegFile.worker.file;

          if (!coreJsFile || !coreWasmFile) {
            showStatus(
              "没有找到 ffmpeg-core.js 或 ffmpeg-core.wasm 文件，无法初始化 FFmpeg",
              "error"
            );
            return;
          }

          // 使用找到的FFmpeg文件进行初始化
          await initializeFFmpegWithFiles(
            coreJsFile,
            coreWasmFile,
            coreWorkerFile
          );

          if (!isFFmpegInitialized) {
            showStatus("FFmpeg 初始化失败", "error");
            return;
          }
        }

        if (videoFiles.length === 0) {
          showStatus("没有选择视频文件", "error");
          return;
        }

        const gallery = document.getElementById("imageGallery");
        // 不清空gallery，让图片和视频结果都显示

        showStatus(`正在处理 ${videoFiles.length} 个视频...`, "info");

        let processedCount = 0;

        for (const videoItem of videoFiles) {
          try {
            showStatus(`正在处理视频: ${videoItem.file.name}`, "info");

            // 将视频文件写入FFmpeg虚拟文件系统
            const inputFileName = videoItem.file.name;
            await ffmpeg.writeFile(
              inputFileName,
              await fetchFile(videoItem.file)
            );

            // 构建转码命令
            const outputFileName = `output_${inputFileName.replace(
              /\.[^/.]+$/,
              ""
            )}.mp4`;
            const command = [
              "-i",
              inputFileName,
              "-c:a",
              "copy", // 音频不转，直接copy
              "-preset",
              "ultrafast", // 编码速度
              "-c:v",
              "libx264", // H.264编码器
              outputFileName, // 输出文件名
            ];

            // 执行转码
            await ffmpeg.exec(command);

            // 读取转码后的文件
            const data = await ffmpeg.readFile(outputFileName);

            // 创建视频展示元素
            const videoItemElement = document.createElement("div");
            videoItemElement.className = "image-item";

            const video = document.createElement("video");
            video.controls = true;
            video.style.maxWidth = "100%";
            video.style.height = "auto";
            video.src = URL.createObjectURL(
              new Blob([data.buffer], { type: "video/mp4" })
            );

            const info = document.createElement("div");
            info.className = "image-info";
            info.innerHTML = `
              <strong>原文件:</strong> ${videoItem.file.name}<br>
              <strong>路径:</strong> ${videoItem.path}<br>
              <strong>格式:</strong> MP4<br>
              <strong>类型:</strong> 视频
            `;

            const downloadBtn = document.createElement("button");
            downloadBtn.className = "download-btn";
            downloadBtn.textContent = "下载视频";
            downloadBtn.onclick = () => {
              const a = document.createElement("a");
              a.href = video.src;
              a.download = outputFileName;
              a.click();
            };

            videoItemElement.appendChild(video);
            videoItemElement.appendChild(info);
            videoItemElement.appendChild(downloadBtn);

            gallery.appendChild(videoItemElement);

            processedCount++;
            showStatus(
              `已处理 ${processedCount}/${videoFiles.length} 个视频`,
              "info"
            );

            // 清理FFmpeg虚拟文件系统中的文件
            try {
              await ffmpeg.deleteFile(inputFileName);
              await ffmpeg.deleteFile(outputFileName);
            } catch (e) {
              console.warn("清理临时文件失败:", e);
            }
          } catch (error) {
            console.error(`处理视频 ${videoItem.file.name} 失败:`, error);
            showStatus(
              `处理视频 ${videoItem.file.name} 失败: ${error.message}`,
              "error"
            );
          }
        }

        showStatus(
          `视频处理完成！共处理了 ${processedCount} 个视频`,
          "success"
        );
      }

      // 创建读取设置
      function createReadSettings() {
        return ImageMagick.createReadSettings();
      }

      // 写入图片
      function writeImage(image, originalName, originalPath, format = "jpeg") {
        image.write(
          MagickFormat.Jpeg,
          (jpgData) => {
            const blob = new Blob([jpgData], { type: `image/${format}` });
            const url = URL.createObjectURL(blob);

            // 创建图片展示元素
            const imageItem = document.createElement("div");
            imageItem.className = "image-item";

            const img = document.createElement("img");
            img.src = url;
            img.alt = `处理后的 ${originalName}`;

            const info = document.createElement("div");
            info.className = "image-info";
            info.innerHTML = `
            <strong>原文件:</strong> ${originalName}<br>
            <strong>路径:</strong> ${originalPath}<br>
            <strong>格式:</strong> ${format.toUpperCase()}
          `;

            const downloadBtn = document.createElement("button");
            downloadBtn.className = "download-btn";
            downloadBtn.textContent = "下载图片";
            downloadBtn.onclick = () => {
              const a = document.createElement("a");
              a.href = url;
              a.download = `processed_${originalName.replace(
                /\.[^/.]+$/,
                ""
              )}.${format}`;
              a.click();
            };

            imageItem.appendChild(img);
            imageItem.appendChild(info);
            imageItem.appendChild(downloadBtn);

            document.getElementById("imageGallery").appendChild(imageItem);
          },
          format
        );
      }

      // 事件监听器
      document
        .getElementById("selectFolder")
        .addEventListener("click", selectFolder);
      document
        .getElementById("processImages")
        .addEventListener("click", processImages);
      document
        .getElementById("processVideos")
        .addEventListener("click", processVideos);

      // 页面加载完成后检查库是否加载
      window.addEventListener("load", () => {
        // 检查 UMD 库是否加载成功
        if (!initializeImageMagick || !ImageMagick) {
          showStatus(
            "ImageMagick 库未正确加载，请检查 dist/index.umd.cjs 文件",
            "error"
          );
        } else {
          showStatus("请选择包含图片和 WASM 文件的文件夹", "info");
        }
      });
    </script>
  </body>
</html>
